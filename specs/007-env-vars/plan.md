# Implementation Plan: Environment Variables

**Branch**: `007-env-vars` | **Date**: 2025-11-26 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-env-vars/spec.md`

## Summary

Add environment variable support to rush shell including `$VAR` expansion in commands, `export` builtin for setting variables, and `set` builtin for listing variables. Variables are inherited from the parent process on startup and passed to child processes during execution.

## Technical Context

**Language/Version**: Rust 1.75+ (edition 2021)
**Primary Dependencies**: std::env, std::process::Command (standard library only)
**Storage**: In-memory HashMap for session variables; no persistent storage
**Testing**: cargo test with unit tests and integration tests
**Target Platform**: macOS (MVP)
**Project Type**: Single project (monorepo crate)
**Performance Goals**: <1ms variable expansion overhead per command (SC-002)
**Constraints**: <100ms shell startup (constitution), <5ms command execution overhead
**Scale/Scope**: ~50-100 environment variables typical; support unlimited

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Requirement | Compliance | Notes |
|-----------|-------------|------------|-------|
| I. Performance-First | <100ms startup, <5ms command overhead | ✅ PASS | Variable expansion adds ~0.1ms per command |
| II. Zero-Config | Works without configuration | ✅ PASS | Inherits system env automatically |
| III. Progressive Complexity | Simple by default | ✅ PASS | Basic $VAR works immediately |
| IV. Modern UX | Syntax highlighting, completions | ✅ PASS | Variables can integrate with highlighting |
| V. Rust-Native | Pure Rust, idiomatic | ✅ PASS | Uses only std library |

**Gate Status**: PASSED - No violations, no justification needed.

## Project Structure

### Documentation (this feature)

```text
specs/007-env-vars/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # Data structures design
├── quickstart.md        # Implementation guide
├── contracts/           # Internal API contracts
│   └── environment.md   # Environment manager API
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
crates/rush/src/
├── executor/
│   ├── mod.rs           # Add Environment struct
│   ├── parser.rs        # Add expand_variables() function
│   ├── execute.rs       # Integrate environment manager
│   ├── pipeline.rs      # Pass environment to child processes
│   └── builtins/
│       ├── mod.rs       # Register export, set builtins
│       ├── export.rs    # NEW: export builtin
│       └── set.rs       # NEW: set builtin
└── lib.rs               # Export environment module

crates/rush/tests/
├── integration/
│   └── env_vars.rs      # NEW: Integration tests for env vars
└── unit/
    └── expansion.rs     # NEW: Unit tests for variable expansion
```

**Structure Decision**: Single project structure, adding new modules to existing `executor/builtins/` directory following established patterns.

## Architecture Design

### Component Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         REPL Input                               │
│                    "echo $HOME | grep /Users"                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      parser.rs                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ tokenize_with_pipes() → split_into_segments()           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                │                                 │
│                                ▼                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ NEW: expand_variables(segments, &env_manager)           │    │
│  │   - Scan each arg for $VAR or ${VAR}                    │    │
│  │   - Replace with env_manager.get(name)                  │    │
│  │   - Handle escape sequences (\$)                        │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     execute.rs                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ CommandExecutor                                          │    │
│  │   - env_manager: EnvironmentManager                     │    │
│  │   - Check for builtins (export, set)                    │    │
│  │   - Pass env to pipeline executor                       │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    ▼                       ▼
        ┌───────────────────┐   ┌───────────────────────────┐
        │    Builtins       │   │    pipeline.rs            │
        │  ┌─────────────┐  │   │  ┌─────────────────────┐  │
        │  │ export.rs   │  │   │  │ spawn_with_env()    │  │
        │  │ set.rs      │  │   │  │ cmd.envs(&env)      │  │
        │  └─────────────┘  │   │  └─────────────────────┘  │
        └───────────────────┘   └───────────────────────────┘
```

### Data Flow

1. **Startup**: `EnvironmentManager::new()` inherits from `std::env::vars()`
2. **Input**: User types `echo $HOME`
3. **Parse**: Tokenizer creates `["echo", "$HOME"]`
4. **Expand**: `expand_variables()` transforms to `["echo", "/Users/username"]`
5. **Execute**: Pipeline spawns process with expanded args
6. **Child Env**: `cmd.envs(env_manager.export_env())` passes variables

### Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Storage | HashMap<String, String> | O(1) lookup, matches std::env API |
| Expansion point | After parsing, before execution | Respects quotes, clean separation |
| Quote handling | Track in tokenizer | Double quotes expand, single don't |
| Invalid var names | Error on export | Fail fast, clear feedback |
| Undefined vars | Empty string | POSIX behavior, no error |

## Deployment Strategy

**How this feature will be delivered incrementally via pull requests.**

### Pull Request Plan

**CRITICAL: Keep PRs small and reviewable (see CLAUDE.md for limits).**

**Strategy**: Option 2 - PR per User Story (RECOMMENDED)

### Selected Strategy

4 User Stories → 4 PRs (US1+US4 combined as foundation, then US2, US3, polish)

**Rationale**: US1 (expansion) and US4 (inheritance) are tightly coupled and foundational. US2 (export) and US3 (set) are independent builtins that build on the foundation.

### Merge Sequence

1. **PR #1: Foundation - Environment Inheritance + Variable Expansion** (~800 lines)
   - EnvironmentManager struct with inheritance
   - expand_variables() in parser.rs
   - Integration into CommandExecutor
   - Unit tests for expansion
   - Covers US1 + US4 (both P1)

2. **PR #2: Export Builtin** (~400 lines)
   - export.rs builtin implementation
   - Child process environment passing
   - Tests for export functionality
   - Covers US2 (P2)

3. **PR #3: Set Builtin** (~300 lines)
   - set.rs builtin implementation
   - Variable listing functionality
   - Tests for set command
   - Covers US3 (P3)

4. **PR #4: Polish & Edge Cases** (~200 lines)
   - Edge case handling (escaping, invalid names)
   - Documentation updates
   - Integration tests

**Branch Strategy**: Work on `007-env-vars` branch, create focused commits per PR scope.

### PR Size Validation

**Before creating each PR, verify size**:
```bash
git diff --stat main  # Check line count
```

**Size Limits** (from CLAUDE.md):
- ✅ Ideal: ≤ 500 lines
- ⚠️ Maximum: ≤ 1,500 lines
- ❌ Too large: > 3,000 lines (must split)

### Estimated Line Counts

| PR | Scope | Est. Lines |
|----|-------|------------|
| PR #1 | Foundation | ~800 |
| PR #2 | Export | ~400 |
| PR #3 | Set | ~300 |
| PR #4 | Polish | ~200 |
| **Total** | | ~1,700 |

All PRs within limits. Total feature size is reasonable.

## Complexity Tracking

> **No violations to justify** - Design uses only standard library, no complex dependencies, no required configuration.

## Integration Points

### Files to Modify

| File | Changes |
|------|---------|
| `executor/mod.rs` | Add `EnvironmentManager` struct, export module |
| `executor/parser.rs` | Add `expand_variables()` function |
| `executor/execute.rs` | Add `env_manager` field, integrate with parsing |
| `executor/pipeline.rs` | Pass environment to `Command::envs()` |
| `executor/builtins/mod.rs` | Register `export` and `set` builtins |

### New Files

| File | Purpose |
|------|---------|
| `executor/builtins/export.rs` | `export VAR=value` builtin |
| `executor/builtins/set.rs` | `set` builtin to list variables |
| `executor/environment.rs` | `EnvironmentManager` implementation |

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Quote handling complexity | Medium | Medium | Track quote type in tokenizer |
| Performance regression | Low | High | Benchmark expansion, optimize hot path |
| Breaking existing tests | Low | Medium | Run full test suite before merge |
| Edge case bugs | Medium | Low | Comprehensive edge case tests |

## Success Metrics

From spec SC-001 through SC-005:

- [ ] `echo $HOME` works within 1 second of startup
- [ ] Variable expansion < 1ms overhead
- [ ] 100% system env vars accessible on startup
- [ ] `export FOO=bar && echo $FOO` works in < 5 seconds
- [ ] Child processes receive exported variables
